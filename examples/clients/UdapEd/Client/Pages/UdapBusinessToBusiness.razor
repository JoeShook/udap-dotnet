@page "/udapBusinessToBusiness"


<ErrorBoundary @ref="ErrorBoundary">
  <ChildContent>
    <MudGrid Class="mt-4">
      <MudItem xs="12" sm="12" md="12">
        <MudText Typo="Typo.h4">Business-to-Business</MudText>
        <MudText Typo="Typo.h6" Color="Color.Tertiary">Requesting Access Tokens for either client_credentials or authorization_code flows</MudText>
      </MudItem>

      <MudGrid Spacing="1" Justify="Justify.FlexStart" Class="mb-2">
        <MudItem xs="4" Class="pa-4">
          <MudTextField Label="Client Id:" @bind-Value="ClientId" />
        </MudItem>
        <MudItem xs="4" Class="pa-4">
          <MudTextField Label="OAth2 Flow"  @bind-Value="Oauth2Flow" />
        </MudItem>
      </MudGrid>
    </MudGrid>


        @if (AppState.Oauth2Flow == Oauth2FlowEnum.client_credentials)
        {
        <MudGrid>
          <MudItem xs="4">
            <MudButton Class="d-inline m-3"
                   ButtonType="ButtonType.Button"
                   Variant="Variant.Filled"
                   Disabled="@(AppState.RegistrationDocument == null && string.IsNullOrEmpty(ClientId))"
                   OnClick="BuildAccessTokenRequest">Build Access Token Request</MudButton>
          </MudItem>
          <MudItem xs="3">
            <MudSwitch Class="d-inline m-3" Label="@(LegacyMode ? "udap.org Mode (sub==iss==SubjectAltName)"
                              : "HL7 FHIR Mode (sub==iss==client_id)")"
                   T="bool"
                   @bind-Checked="@LegacyMode" />
          </MudItem>
        </MudGrid>
        <MudGrid Spacing="1" Class="mt-8">

          <MudItem xs="7">
            <MudPaper Class="pa-4 ma-2" Elevation="3">
              <MudText Align="Align.Right" Color="Color.Tertiary">
                5.2 Client Credentials Flow Request
              </MudText>
              <MudText Align="Align.Right" Color="Color.Tertiary">
                Client Token Request
              </MudText>
              <pre>@TokenRequest1</pre>
              <pre style="padding-left: 10px">@TokenRequest2</pre>

              <pre style="padding-left:10px; background-color:lightyellow">@TokenRequest3</pre>
              <pre style="padding-left: 10px">@TokenRequestScope</pre>
              <pre style="padding-left:10px">@TokenRequest4</pre>
            </MudPaper>
          </MudItem>

          <MudItem xs="5">
            <MudPaper Class="pa-4 ma-2" Elevation="3">
              <MudText Align="Align.Right" Color="Color.Tertiary">Future Info</MudText>
              @* <pre>@if (ClientAssertionDecoded != null) *@
              @*               { *@
              @*                   @((MarkupString)ClientAssertionDecoded) *@
              @*               }</pre> *@
              <SignedJwtViewer Title="<b>Decoded client_assertion::</b>"
                           SignedSoftwareStatement="@AppState.ClientCredentialsTokenRequest?.ClientAssertion?.Value" />
            </MudPaper>
          </MudItem>

        </MudGrid>
        }

        @if (AppState.Oauth2Flow == Oauth2FlowEnum.authorization_code)
        {
        <MudButton Class="d-inline m-3"
               ButtonType="ButtonType.Button"
               Variant="Variant.Filled"
               Disabled="@(AppState.RegistrationDocument == null)"
               OnClick="BuildAuthCodeRequest">Build Access Code Request</MudButton>

        <MudGrid Spacing="1" Class="mt-8">
          <MudItem xs="7">
            <MudPaper Class="pa-4 ma-2" Elevation="3">
              <MudText Align="Align.Right" Color="Color.Tertiary">3.1 Authorization Code Flow</MudText>
                        @if (AppState.AuthorizationCodeRequest != null)
                        {
                  <pre>GET /authorize?</pre>
                  <input Class="pre udap-indent-1" @bind-value="AppState.AuthorizationCodeRequest.ResponseType" @oninput="BuildAuthorizeLink" />
                  <input Class="pre udap-indent-1" @bind-value="AppState.AuthorizationCodeRequest.State" @oninput="BuildAuthorizeLink" />
                  <input Class="pre udap-indent-1" @bind-value="AppState.AuthorizationCodeRequest.ClientId" @oninput="BuildAuthorizeLink" />
                  <input Class="pre udap-indent-1" @bind-value="AppState.AuthorizationCodeRequest.Scope" @oninput="BuildAuthorizeLink" />
                  <input Class="pre udap-indent-1" @bind-value="AppState.AuthorizationCodeRequest.RedirectUri" @oninput="BuildAuthorizeLink" />
                  <input Class="pre udap-indent-1" @bind-value="AppState.AuthorizationCodeRequest.Aud" @oninput="BuildAuthorizeLink" />
                  <pre>Host: @AppState.UdapMetadata?.AuthorizationEndpoint</pre>
                        }
            </MudPaper>
          </MudItem>
          <MudItem xs="5">
            <MudPaper Class="pa-4 ma-2" Elevation="3">
              <MudText Align="Align.Right" Color="Color.Tertiary">Future Info</MudText>
              <pre>Todo</pre>
            </MudPaper>
          </MudItem>
        </MudGrid>

        <MudGrid>
          <MudItem>
            <MudButton Class="mt-3"
                   ButtonType="ButtonType.Button"
                   Variant="Variant.Filled"
                   Disabled="@(AppState.RegistrationDocument == null)"
                   OnClick="GetAccessCode">View Intermediate Redirect</MudButton>
          </MudItem>
          <MudItem>
            <MudButton Class="mt-3"
                   Disabled="@(string.IsNullOrWhiteSpace(AuthCodeRequestLink))"
                   OnClick="@LaunchAuthorize">
              Run Authorize Code Request
            </MudButton>
          </MudItem>
        </MudGrid>

        <MudTextField ReadOnly="true" @bind-Value="AuthCodeRequestLink"></MudTextField>


        <MudGrid Spacing="1" Class="mt-8">
          <MudItem xs="7">
            <MudPaper Class="pa-4 ma-2" Elevation="3">
              <MudText Align="Align.Right" Color="Color.Tertiary">3.1 Authorization Code Flow</MudText>

              <MudText Color="@(AppState.AccessCodeRequestResult is {IsError: true } ? Color.Error : Color.Primary)">
                            @LoginRedirectLinkText
              </MudText>
              <pre>@AppState.AccessCodeRequestResult?.RedirectUrl</pre>

                        @if (AppState.AccessCodeRequestResult?.IsError == true &&
                       AppState.AccessCodeRequestResult.Message != null)
                        {
                  <pre>@AppState.AccessCodeRequestResult?.Message</pre>
                        }

                        @if (AppState.AccessCodeRequestResult?.Cookies != null)
                        {
                            @if (AppState.AccessCodeRequestResult?.Cookies != null)
                            {
                      <pre style="font-weight: bold;">cookies:</pre>
                        <pre>
                                    @((MarkupString)String.Join("\r\n", AppState.AccessCodeRequestResult.Cookies))
                        </pre>
                            }
                        }
            </MudPaper>
          </MudItem>
          <MudItem xs="5">
            <MudPaper Class="pa-4 ma-2" Elevation="3">
              <MudText Align="Align.Right" Color="Color.Tertiary">Future Info</MudText>
              <pre>Todo</pre>
            </MudPaper>
          </MudItem>
        </MudGrid>


        <MudGrid Spacing="1" Class="mt-8">
          <MudItem xs="7">
            <MudPaper Class="pa-4 ma-2" Elevation="3">
              <MudText Align="Align.Right" Color="Color.Tertiary">3.1 Authorization Code Flow</MudText>
              <pre>HTTP/1.1 302 Found</pre>
              <pre style="padding-left: 10px">@LoginCallback()</pre>
            </MudPaper>
          </MudItem>
          <MudItem xs="5">
            <MudPaper Class="pa-4 ma-2" Elevation="3">
              <MudText Align="Align.Right" Color="Color.Tertiary">Future Info</MudText>
              <pre>Todo</pre>
            </MudPaper>
          </MudItem>
        </MudGrid>

        <MudGrid Justify="Justify.FlexStart">
          <MudItem xs="4">
            <MudButton ButtonType="ButtonType.Button"
                   Variant="Variant.Filled"
                   Disabled="@(AppState.RegistrationDocument == null)"
                   OnClick="BuildAccessTokenRequest">Build Access Token Request</MudButton>
          </MudItem>
          <MudItem xs="3">
            <MudSwitch Label="@(LegacyMode ? "udap.org Mode (sub==iss==SubjectAltName)" : "HL7 FHIR Mode (sub==iss==client_id)")"
                   T="bool"
                   @bind-Checked="@LegacyMode" />
          </MudItem>
        </MudGrid>
        <MudGrid Spacing="1" Class="mt-8">
          <MudItem xs="7">
            <MudPaper Class="pa-4 ma-2" Elevation="3">
              <MudText Align="Align.Right" Color="Color.Tertiary">5.1 Authorization Code Flow</MudText>
              <pre>@TokenRequest1</pre>
              <pre style="padding-left: 10px">@TokenRequest2</pre>
              <pre style="padding-left:10px; background-color:lightyellow">@TokenRequest3</pre>
              <pre style="padding-left:10px">@TokenRequest4</pre>
            </MudPaper>
          </MudItem>
          <MudItem xs="5">
            <MudPaper Class="pa-4 ma-2" Elevation="3">
              <MudText Align="Align.Right" Color="Color.Tertiary">Future Info</MudText>
              <pre>@if (ClientAssertionDecoded != null)
                            {
                                @((MarkupString)ClientAssertionDecoded)
                            }</pre>
            </MudPaper>
          </MudItem>
        </MudGrid>
        }

    <MudButton Class="mt-3"
               ButtonType="ButtonType.Button"
               Variant="Variant.Filled"
               Disabled="@(AppState.RegistrationDocument == null)"
               OnClick="GetAccessToken">Get Access Token</MudButton>

    <MudGrid Spacing="1" Class="mt-8">
      <MudItem xs="7">
        <MudPaper Class="pa-4 ma-2" Elevation="3">
          <MudText Align="Align.Right" Color="Color.Tertiary">7.1 Success</MudText>
          <pre>@AccessToken</pre>
        </MudPaper>
      </MudItem>
    </MudGrid>

  </ChildContent>
  <ErrorContent Context="ex">
        @{
            Console.Write(ex.Message);
        }
    <pre class="blazor-error-boundary">
            @ex.Message
      </pre>
  </ErrorContent>
</ErrorBoundary>